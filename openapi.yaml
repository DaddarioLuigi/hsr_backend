openapi: 3.0.0
info:
  title: HSR Backend API
  version: 1.0.0
  description: >
    API per la gestione di pazienti, documenti clinici, entità estratte ed esportazione dati in Excel.

servers:
  - url: http://localhost:5000

paths:
  /api/patients:
    get:
      summary: Elenco pazienti
      description: Restituisce la lista di tutti i pazienti presenti nel sistema.
      responses:
        '200':
          description: Lista pazienti
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PatientSummary'

  /api/patient/{patient_id}:
    get:
      summary: Dettaglio paziente e lista documenti
      description: Restituisce i dettagli di un paziente e la lista dei suoi documenti.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Dettaglio paziente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatientDetail'
        '404':
          description: Paziente non trovato

  /api/upload-document:
    post:
      summary: Caricamento documento PDF
      description: |
        Carica uno o più file PDF per un paziente e avvia l'elaborazione. Sono accettati solo PDF.
        
        **Nuovo parametro `process_as_packet`**: 
        - Se `true`, il documento viene trattato come pacchetto clinico completo da segmentare
        - Ogni sezione identificata viene gestita come documento indipendente
        - Se `false` (default), usa il flusso originale per singoli documenti
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                patient_id:
                  type: string
                  description: ID paziente (opzionale se process_as_packet=true)
                process_as_packet:
                  type: string
                  description: Se "true", tratta il documento come pacchetto clinico da segmentare
                  enum: ["true", "false"]
                  default: "false"
              required:
                - file
      responses:
        '200':
          description: Documento caricato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Parametri mancanti o formato non supportato (solo PDF)
        '413':
          description: Dimensioni upload eccessive

  /api/document-packet-status/{patient_id}:
    get:
      summary: Stato processing pacchetto clinico
      description: |
        Ottiene lo stato del processing di un documento trattato come pacchetto clinico.
        Ritorna informazioni su sezioni trovate, mancanti e documenti creati.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stato del processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PacketProcessingStatus'
        '404':
          description: Nessun documento in processing trovato

  /api/coherence-status/{patient_id}:
    get:
      summary: Stato coerenza metadati paziente
      description: |
        Verifica lo stato di coerenza dei metadati per un paziente.
        Ritorna informazioni sulla presenza della lettera di dimissione
        e sulla coerenza con i documenti esistenti.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stato della coerenza
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoherenceStatusResponse'
        '500':
          description: Errore interno del server

  /api/check-document-coherence:
    post:
      summary: Verifica coerenza documento
      description: |
        Verifica la coerenza di un documento prima del caricamento.
        Utile per controllare preventivamente se un documento sarà accettato.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                patient_id:
                  type: string
                  description: ID del paziente
                document_type:
                  type: string
                  description: Tipo di documento
                metadata:
                  type: object
                  description: Metadati del documento da verificare
              required:
                - patient_id
                - document_type
                - metadata
      responses:
        '200':
          description: Risultato della verifica di coerenza
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoherenceCheckResponse'
        '400':
          description: Parametri mancanti o non validi
        '500':
          description: Errore interno del server


  /api/document-ocr-text/{patient_id}:
    get:
      summary: Testo OCR estratto
      description: Ottiene il testo OCR salvato per un paziente.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Testo OCR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OCRTextResponse'
        '404':
          description: Testo OCR non trovato

  /api/set-patient-id/{patient_id}:
    post:
      summary: Imposta manualmente ID paziente
      description: |
        Imposta manualmente il numero di cartella clinica quando il processing automatico fallisce.
        Utile quando non c'è una lettera di dimissione o l'estrazione automatica dell'ID non funziona.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
          description: ID temporaneo del paziente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                new_patient_id:
                  type: string
                  description: Nuovo numero di cartella clinica
              required:
                - new_patient_id
      responses:
        '200':
          description: ID paziente aggiornato
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  old_patient_id:
                    type: string
                  new_patient_id:
                    type: string
                  message:
                    type: string
        '400':
          description: Parametri mancanti
        '404':
          description: Paziente temporaneo non trovato
        '409':
          description: Nuovo ID già esistente

  /api/restart-processing/{patient_id}:
    post:
      summary: Riavvia processing con ID specifico
      description: |
        Riavvia il processing di un documento con un ID specifico quando il processing automatico fallisce.
        Utile quando si vuole specificare manualmente il numero di cartella clinica.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
          description: ID temporaneo del paziente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                patient_id:
                  type: string
                  description: Nuovo numero di cartella clinica per il processing
              required:
                - patient_id
      responses:
        '200':
          description: Processing riavviato
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  old_patient_id:
                    type: string
                  new_patient_id:
                    type: string
                  filename:
                    type: string
                  message:
                    type: string
                  status:
                    type: string
        '400':
          description: Parametri mancanti
        '404':
          description: Paziente temporaneo non trovato
        '409':
          description: Nuovo ID già esistente

  /api/force-complete-status/{patient_id}:
    post:
      summary: Forza aggiornamento stato finale
      description: |
        Forza l'aggiornamento dello stato finale quando il processing è completato.
        Utile quando il frontend non riceve gli aggiornamenti di stato.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
          description: ID del paziente
      responses:
        '200':
          description: Stato finale aggiornato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PacketProcessingStatus'
        '500':
          description: Errore interno del server


  /api/debug-processing-status/{patient_id}:
    get:
      summary: Stato debug processing
      description: Ottiene lo stato di debug per il processing di un paziente.
      parameters:
        - in: path
          name: patient_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stato debug
          content:
            application/json:
              schema:
                type: object
                properties:
                  patient_id:
                    type: string
                  status:
                    type: string
                  message:
                    type: string
                  progress:
                    type: integer
                    minimum: 0
                    maximum: 100
                  filename:
                    type: string
                  sections_found:
                    type: array
                    items:
                      type: string
                  sections_missing:
                    type: array
                    items:
                      type: string
                  documents_created:
                    type: array
                    items:
                      type: object
                      properties:
                        document_id:
                          type: string
                        document_type:
                          type: string
                        filename:
                          type: string
                        status:
                          type: string
                          enum: [processed]
                        entities_count:
                          type: integer
                  errors:
                    type: array
                    items:
                      type: string
        '404':
          description: Paziente non trovato

  /api/document/{document_id}:
    get:
      summary: Dati per l'editor di entità
      description: Restituisce i dati di un documento, incluse le entità estratte e il percorso del PDF.
      parameters:
        - in: path
          name: document_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Dati documento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentDetail'
        '404':
          description: Documento non trovato
    put:
      summary: Aggiorna le entità di un documento
      description: Aggiorna il file entities.json per un documento specifico.
      parameters:
        - in: path
          name: document_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                entities:
                  type: array
                  items:
                    $ref: '#/components/schemas/Entity'
      responses:
        '200':
          description: Entità aggiornate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateEntitiesResponse'
        '400':
          description: Formato entità non valido
        '500':
          description: Errore durante il salvataggio
    delete:
      summary: Cancella un documento
      description: Cancella il PDF e i file associati. Se il paziente rimane senza documenti, viene rimosso.
      parameters:
        - in: path
          name: document_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Documento cancellato (eventuali cartelle ripulite)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  patient_deleted:
                    type: boolean
                  document_type_deleted:
                    type: boolean
        '404':
          description: Documento non trovato

  /api/export-excel:
    get:
      summary: Esporta tutti i dati in Excel
      description: Restituisce il file Excel con tutti i dati clinici.
      responses:
        '200':
          description: File Excel generato
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

components:
  schemas:
    PatientSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        document_count:
          type: integer
        last_document_date:
          type: string
          format: date
          nullable: true

    PatientDetail:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        documents:
          type: array
          items:
            $ref: '#/components/schemas/DocumentSummary'

    DocumentSummary:
      type: object
      properties:
        id:
          type: string
        filename:
          type: string
        document_type:
          type: string
        upload_date:
          type: string
          format: date
          nullable: true
        entities_count:
          type: integer
        status:
          type: string
          enum: [processed, processing]

    UploadResponse:
      type: object
      properties:
        document_id:
          type: string
        patient_id:
          type: string
        document_type:
          type: string
        filename:
          type: string
        status:
          type: string
          enum: [processing]

    DocumentDetail:
      type: object
      properties:
        id:
          type: string
        patient_id:
          type: string
        document_type:
          type: string
        filename:
          type: string
        pdf_path:
          type: string
        entities:
          type: array
          items:
            $ref: '#/components/schemas/Entity'

    Entity:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        value:
          type: string
        confidence:
          type: number
          format: float

    PacketProcessingStatus:
      type: object
      properties:
        patient_id:
          type: string
        status:
          type: string
          enum: [ocr_start, segmenting, processing_sections, completed, completed_with_errors, failed]
        message:
          type: string
        progress:
          type: integer
          minimum: 0
          maximum: 100
        filename:
          type: string
        sections_found:
          type: array
          items:
            type: string
          description: Lista dei tipi di sezione identificati nel documento
        sections_missing:
          type: array
          items:
            type: string
          description: Lista dei tipi di sezione attesi ma non trovati
        documents_created:
          type: array
          items:
            type: object
            properties:
              document_id:
                type: string
              document_type:
                type: string
              filename:
                type: string
              status:
                type: string
                enum: [processed]
              entities_count:
                type: integer
        errors:
          type: array
          items:
            type: string
          description: Lista degli errori riscontrati durante il processing
        warnings:
          type: array
          items:
            type: string
          description: Lista dei warning (es. mancanza lettera di dimissione)

    OCRTextResponse:
      type: object
      properties:
        patient_id:
          type: string
        filename:
          type: string
        ocr_text:
          type: string
          description: Testo completo estratto via OCR
        metadata:
          type: object
          properties:
            original_filename:
              type: string
            upload_date:
              type: string
              format: date
            content_type:
              type: string

    UpdateEntitiesResponse:
      type: object
      properties:
        success:
          type: boolean
        document_id:
          type: string
        message:
          type: string

    CoherenceStatusResponse:
      type: object
      properties:
        has_lettera_dimissione:
          type: boolean
          description: Se esiste una lettera di dimissione per il paziente
        total_documents:
          type: integer
          description: Numero totale di documenti del paziente
        incoerenti:
          type: integer
          description: Numero di documenti incoerenti (solo se has_lettera_dimissione=true)
        coherence_status:
          type: string
          enum: [pending_ld, coherent, incoherent]
          description: Stato della coerenza
        incoerenti_details:
          type: array
          items:
            type: object
            properties:
              document_type:
                type: string
              differences:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    atteso:
                      type: string
                    trovato:
                      type: string
          description: Dettagli dei documenti incoerenti (solo se incoerenti > 0)

    CoherenceCheckResponse:
      type: object
      properties:
        status:
          type: string
          enum: [accepted, rejected]
          description: Status della verifica di coerenza
        reason:
          type: string
          description: Motivo dell'accettazione o rifiuto
        diff:
          type: object
          additionalProperties:
            type: object
            properties:
              atteso:
                type: string
              trovato:
                type: string
          description: Differenze trovate (solo se status=rejected)
        references:
          type: string
          description: Riferimento alla lettera di dimissione usata per il confronto
        incoerenti:
          type: array
          items:
            type: object
            properties:
              document_type:
                type: string
              differences:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    atteso:
                      type: string
                    trovato:
                      type: string
          description: Lista documenti incoerenti (solo per lettera di dimissione)

 