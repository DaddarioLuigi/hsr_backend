# llm/prompts.py

from typing import Dict, List

class PromptManager:
    """
    Gestisce schemi JSON e prompt testuali per l'estrazione di entit√†.
    """

    SCHEMAS: Dict[str, dict] = {
        "lettera_dimissione": {
            "name": "lettera_dimissione",
            "title": "Scheda Cardiochirurgia",
            "type": "object",
            "properties": {
                "n_cartella": { "type": "number" },
                "data_ingresso_cch": { "type": "string", "format": "date" },
                "data_dimissione_cch": { "type": "string", "format": "date" },
                "nome": { "type": "string" },
                "cognome": { "type": "string" },
                "sesso": { "type": "string", "enum": ["M", "F"] },
                "numero_di_telefono": { "type": "string" },
                "eta_al_momento_dell_intervento": { "type": "number" },
                "data_di_nascita": { "type": "string", "format": "date" },
                "Diagnosi": { "type": "string" },
                "Anamnesi": { "type": "string" },
                "Motivo_ricovero": { "type": "string" },
                "classe_nyha": { "type": "string", "enum": ["I", "II", "III", "IV"] },
                "angor": { "type": "boolean" },
                "STEMI_NSTEMI": { "type": "boolean" },
                "scompenso_cardiaco_nei_3_mesi_precedenti": { "type": "boolean" },
                "fumo": { "type": "number", "enum": [0, 1, 2] },
                "diabete": { "type": "boolean" },
                "ipertensione": { "type": "boolean" },
                "dislipidemia": { "type": "boolean" },
                "BPCO": { "type": "boolean" },
                "stroke_pregresso": { "type": "boolean" },
                "TIA_pregresso": { "type": "boolean" },
                "vasculopatiaperif": { "type": "boolean" },
                "neoplasia_pregressa": { "type": "boolean" },
                "irradiazionetoracica": { "type": "boolean" },
                "insufficienza_renale_cronica": { "type": "boolean" },
                "familiarita_cardiovascolare": { "type": "boolean" },
                "limitazione_mobilita": { "type": "boolean" },
                "endocardite": { "type": "boolean" },
                "ritmo_all_ingresso": { "type": "number", "enum": [0, 1, 2] },
                "fibrillazione_atriale": { "type": "number", "enum": [0, 1, 2] },
                "dialisi": { "type": "boolean" },
                "elettivo_urgenza_emergenza": { "type": "number", "enum": [0, 1, 2] },
                "pm": { "type": "boolean" },
                "crt": { "type": "boolean" },
                "icd": { "type": "boolean" },
                "pci_pregressa": { "type": "boolean" },
                "REDO": { "type": "boolean" },
                "Anno_REDO": { "type": "string", "format": "date" },
                "Tipo_di_REDO": { "type": "string" },
                "Terapia": { "type": "string" },
                "lasix": { "type": "boolean" },
                "lasix_dosaggio": { "type": "number" },
                "nitrati": { "type": "boolean" },
                "antiaggregante": { "type": "boolean" },
                "dapt": { "type": "boolean" },
                "anticoagorali": { "type": "boolean" },
                "aceinib": { "type": "boolean" },
                "betabloc": { "type": "boolean" },
                "sartanici": { "type": "boolean" },
                "caantag": { "type": "boolean" },
                "esami_all_ingresso": { "type": "string" },
                "Decorso_post_operatorio": { "type": "string" },
                "IABP_ECMO_IMPELLA": { "type": "boolean" },
                "Inotropi": { "type": "boolean" },
                "secondo_intervento": { "type": "boolean" },
                "Tipo_secondo_intervento": { "type": "string" },
                "II_Run": { "type": "boolean" },
                "Causa_II_Run_CEC": { "type": "string" },
                "LCOS": { "type": "boolean" },
                "Impianto_PM_post_intervento": { "type": "boolean" },
                "Stroke_TIA_post_op": { "type": "boolean" },
                "Necessita_di_trasfusioni": { "type": "boolean" },
                "IRA": { "type": "boolean" },
                "Insufficienza_respiratoria": { "type": "boolean" },
                "FA_di_nuova_insorgenza": { "type": "boolean" },
                "Ritmo_alla_dimissione": { "type": "string", "enum": ["0","1","2"] },
                "H_Stay_giorni_da_intervento_a_dimissione": { "type": "number" },
                "Morte": { "type": "boolean" },
                "Causa_morte": { "type": "string" },
                "data_morte": { "type": "string", "format": "date" },
                "esami_alla_dimissione": { "type": "string" },
                "terapia_alla_dimissione": { "type": "string" }
            },
            "required": ["n_cartella", "nome", "cognome"],
            "additionalProperties": True
        },
        "coronarografia": {
            "name": "coronarografia",
            "title": "Scheda Coronarografia",
            "type": "object",
            "properties": {
                "n_cartella": { "type": "number" },
                "nome": { "type": "string" },
                "cognome": { "type": "string" },
                "data_di_nascita": { "type": "string", "format": "date" },
                "data_esame": { "type": "string", "format": "date" },
                "coronarografia text": { "type": "string" },
                "coro_tc_stenosi50": { "type": "boolean" },
                "coro_iva_stenosi50": { "type": "boolean" },
                "coro_cx_stenosi50": { "type": "boolean" },
                "coro_mo1_stenosi50": { "type": "boolean" },
                "coro_mo2_stenosi50": { "type": "boolean" },
                "coro_mo3_stenosi50": { "type": "boolean" },
                "coro_int_stenosi50": { "type": "boolean" },
                "coro_plcx_stenosi50": { "type": "boolean" },
                "coro_dx_stenosi50": { "type": "boolean" },
                "coro_pl_stenosi50": { "type": "boolean" },
                "coro_ivp_stenosi50": { "type": "boolean" }
            },
            "required": ["n_cartella", "nome", "cognome"]
        },
        "eco_preoperatorio": {
            "name": "eco_preoperatorio",
            "title": "Scheda Ecocardiogramma Preoperatorio",
            "type": "object",
            "properties": {
                "n_cartella": { "type": "number" },
                "nome": { "type": "string" },
                "cognome": { "type": "string" },
                "data_di_nascita": { "type": "string", "format": "date" },
                "altezza": { "type": "number" },
                "peso": { "type": "number" },
                "bmi": { "type": "number" },
                "bsa": { "type": "number" },
                "data_esame": { "type": "string", "format": "date" },
                "eco_text": { "type": "string" },         # riassunto referto
                "parametri": { "type": "string" }        # cattura tabellari non mappati singolarmente
            },
            "required": ["n_cartella", "nome", "cognome"],
            "additionalProperties": True
        },
        "eco_postoperatorio": {
            "name": "eco_postoperatorio",
            "title": "Scheda Ecocardiogramma Postoperatorio",
            "type": "object",
            "properties": {
                "data_esame": { "type": "string", "format": "date" },
                "eco_text": { "type": "string" }
            },
            "required": ["data_esame"]
        },
        "tc_cuore": {
            "name": "tc_cuore",
            "title": "Scheda TC Cuore",
            "type": "object",
            "properties": {
                "n_cartella": { "type": "number" },
                "nome": { "type": "string" },
                "cognome": { "type": "string" },
                "data_di_nascita": { "type": "string", "format": "date" },
                "data_esame": { "type": "string", "format": "date" },
                "tac text": { "type": "string" },
                "tc_tc_stenosi50": { "type": "boolean" },
                "tc_iva_stenosi50": { "type": "boolean" },
                "tc_cx_stenosi50": { "type": "boolean" },
                "tc_mo1_stenosi50": { "type": "boolean" },
                "tc_mo2_stenosi50": { "type": "boolean" },
                "tc_mo3_stenosi50": { "type": "boolean" },
                "tc_int_stenosi50": { "type": "boolean" },
                "tc_plcx_stenosi50": { "type": "boolean" },
                "tc_dx_stenosi50": { "type": "boolean" },
                "tc_pl_stenosi50": { "type": "boolean" },
                "tc_ivp_stenosi50": { "type": "boolean" },
                "dimaorta_anulus": { "type": "number" },
                "dimaorta_perimetro": { "type": "number" },
                "dimaorta_radice": { "type": "number" },
                "dimaorta_giunzione": { "type": "number" },
                "dimaorta_asc": { "type": "number" },
                "dimaorta_arco": { "type": "number" },
                "dimaorta_disc": { "type": "number" },
                "area_valv_aortica": { "type": "number" },
                "asse_lungo": { "type": "number" },
                "asse_corto": { "type": "number" },
                "h_media_senocor": { "type": "number" }
            },
            "required": ["n_cartella", "nome", "cognome"]
        },
        "intervento": {
            "name": "intervento",
            "title": "Scheda Intervento Cardiochirurgico",
            "type": "object",
            "properties": {
                "n_cartella": { "type": "number" },
                "nome": { "type": "string" },
                "cognome": { "type": "string" },
                "data_di_nascita": { "type": "string", "format": "date" },  # (CSV: 'dob')
                "data_intervento": { "type": "string", "format": "date" },
                "Percorso": { "type": "string" },                           # Chirurgico / Transcatetere
                "redo": { "type": "boolean" },
                "cec": { "type": "boolean" },
                "cannulazionearteriosa": { "type": "string" },
                "statopaz": { "type": "string" },
                "cardioplegia": { "type": "string" },
                "approcciochirurgico": { "type": "string" },

                "entratainsala": { "type": "string", "format": "time" },
                "iniziointervento": { "type": "string", "format": "time" },
                "iniziocec": { "type": "string", "format": "time" },
                "inizioclamp": { "type": "string", "format": "time" },
                "inizioacc": { "type": "string", "format": "time" },
                "fineacc": { "type": "string", "format": "time" },
                "fineclamp": { "type": "string", "format": "time" },
                "finecec": { "type": "string", "format": "time" },
                "fineintervento": { "type": "string", "format": "time" },
                "uscitasala": { "type": "string", "format": "time" },

                "primo operatore cognome": { "type": "string" },
                "primo operatore nome": { "type": "string" },

                "num_interventi": { "type": "number" },

                # Primo intervento dettagliato (aderente al CSV di esempio)
                "intervento 1": { "type": "string" },
                "protesi 1": { "type": "string" },          # Biologica/Meccanica/Anello
                "modello 1": { "type": "string" },
                "numero 1": { "type": "number" },
                "eziologia_valvolare 1": { "type": "string" },

                # Testo libero (riassunto verbale operatorio)
                "intervento text": { "type": "string" }
            },
            "required": ["n_cartella", "nome", "cognome", "data_intervento"]
        },
            "anamnesi": {
        "name": "anamnesi",
        "title": "Scheda Anamnesi",
        "type": "object",
        "properties": {
            "n_cartella": { "type": "number" },
            "nome": { "type": "string" },
            "cognome": { "type": "string" },
            "data_di_nascita": { "type": "string", "format": "date" },

            "Terapia": { "type": "string" },            # terapia in atto all'ingresso
            "Allergie": { "type": "string" },           # farmacoallergie/intolleranze
            "Abitudini": { "type": "string" },          # fumo/alcol/altro se riportati
            "Comorbidita": { "type": "string" },        # elenco/riassunto comorbidit√†
            "esami_all_ingresso": { "type": "string" }, # labs/strumentali all'ingresso
            "parametri": { "type": "string" }           # key:value; key:value; da tabelle/elenco
        },
        "required": ["n_cartella", "nome", "cognome"],
        "additionalProperties": True
    },
        "epicrisi_ti": {
        "name": "epicrisi_ti",
        "title": "Epicrisi Terapia Intensiva",
        "type": "object",
        "properties": {
            "n_cartella": { "type": "number" },
            "nome": { "type": "string" },
            "cognome": { "type": "string" },
            "data_intervento": { "type": "string", "format": "date" },
            "Decorso_post_operatorio": { "type": "string" },   # ventilazione, emodinamica, complicanze, etc.
            "IABP_ECMO_IMPELLA": { "type": "boolean" },
            "Inotropi": { "type": "boolean" },
            "eventi_avversi_TI": { "type": "string" },         # lista/riassunto eventi ICU
            "data_dimissione_cch": { "type": "string", "format": "date" },
            "parametri": { "type": "string" }                  # tabellari/elenco "chiave: valore; ..."
        },
        "required": ["n_cartella", "nome", "cognome"],
        "additionalProperties": True
    },
        "cartellino_anestesiologico": {
        "name": "cartellino_anestesiologico",
        "title": "Scheda Anestesiologica Intraoperatoria",
        "type": "object",
        "properties": {
            "n_cartella": { "type": "number" },
            "nome": { "type": "string" },
            "cognome": { "type": "string" },
            "data_di_nascita": { "type": "string", "format": "date" },
            "data_intervento": { "type": "string", "format": "date" },

            "entratainsala": { "type": "string", "format": "time" },
            "iniziointervento": { "type": "string", "format": "time" },
            "iniziocec": { "type": "string", "format": "time" },
            "inizioclamp": { "type": "string", "format": "time" },
            "inizioacc": { "type": "string", "format": "time" },
            "fineacc": { "type": "string", "format": "time" },
            "fineclamp": { "type": "string", "format": "time" },
            "finecec": { "type": "string", "format": "time" },
            "fineintervento": { "type": "string", "format": "time" },
            "uscitasala": { "type": "string", "format": "time" },

            "cec": { "type": "boolean" },
            "cardioplegia": { "type": "string" },
            "approcciochirurgico": { "type": "string" },

            "anestesia": { "type": "string" },            # es. generale, locoregionale (se riportato)
            "farmaci_intraop": { "type": "string" },      # elenco/riassunto farmaci
            "eventi_intraop": { "type": "string" },       # eventi/complicanze intraoperatorie
            "parametri": { "type": "string" }             # tabellari: "chiave: valore; ..."
        },
        "required": ["n_cartella", "nome", "cognome", "data_intervento"],
        "additionalProperties": True
    }

    }

    PROMPTS: Dict[str, str] = {
        "lettera_dimissione": '''
Sei un medico specializzato in cardiochirurgia. Il tuo compito √® estrarre le seguenti entit√† dalla **lettera di dimissione** riportata qui sotto.

### Entit√† da estrarre:

### Mappa delle entit√† e tipi

| Entit√†                                      | Tipo              | Descrizione                                                                                                                                     |
|--------------------------------------------|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| n_cartella                                 | Number            | Numero identificativo univoco assegnato alla cartella clinica del paziente.                                                                    |
| data_ingresso_cch                          | Date              | Data in cui il paziente √® stato ricoverato presso il reparto di Cardiochirurgia.                                                              |
| data_dimissione_cch                        | Date              | Data in cui il paziente √® stato dimesso dal reparto di Cardiochirurgia.                                                                        |
| nome                                       | Text              | Nome proprio del paziente.                                                                                                                      |
| cognome                                    | Text              | Cognome del paziente.                                                                                                                           |
| sesso                                      | Categorical_MF    | Sesso biologico del paziente (M = Maschio, F = Femmina).                                                                                        |
| numero di telefono                         | Text              | Recapito telefonico del paziente o di un contatto di riferimento.                                                                              |
| et√† al momento dell'intervento             | Number            | Et√† del paziente calcolata alla data dell‚Äôintervento chirurgico.                                                                               |
| data_di_nascita                            | Date              | Data di nascita del paziente.                                                                                                                   |
| Diagnosi                                   | Text              | Diagnosi principale alla base dell'indicazione chirurgica.                                                                                      |
| Anamnesi                                   | Text              | Anamnesi patologica remota e prossima, utile per la valutazione del rischio operatorio.                                                        |
| Motivo ricovero                            | Text              | Indicazione clinica per il ricovero in Cardiochirurgia.                                                                                         |
| classe_nyha                                | Categorical_1234  | Classe funzionale NYHA per scompenso cardiaco (I-IV), definisce la gravit√† dei sintomi.                                                        |
| angor                                      | Boolean           | Presenza di angina pectoris (dolore toracico di origine ischemica).                                                                            |
| STEMI/NSTEMI                               | Boolean           | Presenza di infarto miocardico acuto con/senza sopraslivellamento del tratto ST.                                                               |
| scompenso_cardiaco_nei_3_mesi_precedenti   | Boolean           | Episodi di scompenso cardiaco documentati nei 3 mesi precedenti l‚Äôintervento.                                                                  |
| fumo                                       | Categorical_012   | Abitudine al fumo (0 = mai fumato, 1 = ex-fumatore, 2 = fumatore attivo).                                                                      |
| diabete                                    | Boolean           | Presenza di diabete mellito noto.                                                                                                               |
| ipertensione                               | Boolean           | Presenza di ipertensione arteriosa.                                                                                                             |
| dislipidemia                               | Boolean           | Presenza di dislipidemia (colesterolo e/o trigliceridi elevati).                                                                               |
| BPCO                                       | Boolean           | Presenza di broncopneumopatia cronica ostruttiva.                                                                                               |
| stroke_pregresso                           | Boolean           | Precedente episodio di ictus cerebrale ischemico o emorragico.                                                                                  |
| TIA_pregresso                              | Boolean           | Episodio pregresso di attacco ischemico transitorio (TIA).                                                                                      |
| vasculopatiaperif                          | Boolean           | Malattia vascolare periferica documentata (es. arteriopatia arti inferiori).                                                                   |
| neoplasia_pregressa                        | Boolean           | Presenza di neoplasie trattate in passato.                                                                                                      |
| irradiazionetoracica                       | Boolean           | Pregressa radioterapia al torace, rilevante per effetti tardivi su cuore e vasi.                                                               |
| insufficienza_renale_cronica               | Boolean           | Presenza di insufficienza renale cronica diagnosticata.                                                                                         |
| familiarita_cardiovascolare                | Boolean           | Familiarit√† per malattie cardiovascolari premature (prima dei 55 anni per uomini, 65 per donne).                                                |
| limitazione_mobilita                       | Boolean           | Presenza di limitazioni significative alla mobilit√† (es. pazienti allettati).                                                                  |
| endocardite                                | Boolean           | Pregressa o attiva endocardite infettiva, rilevante per indicazione chirurgica.                                                                |
| ritmo_all_ingresso                         | Categorical_012   | Ritmo cardiaco al momento del ricovero (0 = ritmo sinusale, 1 = FA, 2 = altro).                                                                 |
| fibrillazione_atriale                      | Categorical_012   | Presenza di fibrillazione atriale (0 = mai, 1 = parossistica, 2 = permanente/persistente).                                                     |
| dialisi                                    | Boolean           | Paziente in trattamento emodialitico o peritoneale.                                                                                             |
| elettivo_urgenza_emergenza                 | Categorical_012   | Tipo di intervento (0 = elettivo, 1 = urgente, 2 = emergenza).                                                                                   |
| pm                                         | Boolean           | Presenza di pacemaker.                                                                                                                          |
| crt                                        | Boolean           | Presenza di terapia di resincronizzazione cardiaca (CRT).                                                                                       |
| icd                                        | Boolean           | Presenza di defibrillatore impiantabile (ICD).                                                                                                  |
| pci_pregressa                              | Boolean           | Precedente angioplastica coronarica percutanea (PCI).                                                                                           |
| REDO                                       | Boolean           | Intervento cardiochirurgico di revisione (non prima chirurgia).                                                                                |
| Anno REDO                                  | Date              | Anno in cui √® stato eseguito l'intervento REDO precedente.                                                                                      |
| Tipo di REDO                               | Text              | Descrizione del tipo di intervento REDO eseguito.                                                                                               |
| Terapia                                    | Text              | Terapia farmacologica in atto al momento del ricovero.                                                                                          |
| lasix                                      | Boolean           | Uso documentato di furosemide (Lasix).                                                                                                          |
| lasix_dosaggio                             | Number            | Dosaggio giornaliero di furosemide in mg.                                                                                                       |
| nitrati                                    | Boolean           | Assunzione di nitrati (vasodilatatori usati per l'angina).                                                                                      |
| antiaggregante                             | Boolean           | Presenza di terapia antiaggregante (es. ASA, clopidogrel).                                                                                      |
| dapt                                       | Boolean           | Doppia antiaggregazione piastrinica (es. ASA + clopidogrel/prasugrel).                                                                          |
| anticoagorali                              | Boolean           | Terapia anticoagulante in corso (es. warfarin, DOAC).                                                                                           |
| aceinib                                    | Boolean           | Uso di ACE-inibitori.                                                                                                                           |
| betabloc                                   | Boolean           | Uso di beta-bloccanti.                                                                                                                          |
| sartanici                                  | Boolean           | Uso di sartani (ARBs).                                                                                                                          |
| caantag                                    | Boolean           | Uso di calcio-antagonisti.                                                                                                                      |
| esami_all_ingresso                         | Text              | Risultati di laboratorio e strumentali al momento dell‚Äôingresso.                                                                               |
| Decorso_post_operatorio                    | Text              | Descrizione del decorso clinico successivo all‚Äôintervento chirurgico.                                                                          |
| IABP/ECMO/IMPELLA                          | Boolean           | Necessit√† di supporto meccanico circolatorio (IABP, ECMO o Impella).                                                                           |
| Inotropi                                   | Boolean           | Necessit√† di farmaci inotropi positivi nel post-operatorio.                                                                                     |
| secondo_intervento                         | Boolean           | Esecuzione di un secondo intervento durante la degenza attuale.                                                                                |
| Tipo_secondo_intervento                    | Text              | Tipo e motivazione del secondo intervento chirurgico.                                                                                           |
| II_Run                                     | Boolean           | Presenza di secondo passaggio in circolazione extracorporea (CEC).                                                                             |
| Causa_II_Run_CEC                           | Text              | Motivazione per il secondo utilizzo della CEC.                                                                                                  |
| LCOS                                       | Boolean           | Sindrome da bassa portata cardiaca (Low Cardiac Output Syndrome) post-operatoria.                                                               |
| Impianto_PM_post_intervento                | Boolean           | Necessit√† di impianto di pacemaker dopo l‚Äôintervento.                                                                                           |
| Stroke_TIA_post_op                         | Boolean           | Evento neurologico ischemico (TIA/stroke) avvenuto dopo l‚Äôintervento.                                                                          |
| Necessit√†_di_trasfusioni                   | Boolean           | Necessit√† di trasfusioni ematiche post-intervento.                                                                                              |
| IRA                                        | Boolean           | Insufficienza renale acuta insorta nel post-operatorio.                                                                                         |
| Insufficienza_respiratoria                 | Boolean           | Insorgenza di insufficienza respiratoria nel post-operatorio.                                                                                   |
| FA_di_nuova_insorgenza                     | Boolean           | Fibrillazione atriale di nuova insorgenza nel post-operatorio.                                                                                  |
| Ritmo_alla_dimissione                      | Categorical_012   | Ritmo cardiaco documentato alla dimissione (0 = sinusale, 1 = FA, 2 = altro).                                                                   |
| H_Stay_giorni (da intervento a dimissione) | Number            | Durata della degenza in giorni, calcolata dall‚Äôintervento alla dimissione.                                                                      |
| Morte                                      | Boolean           | Evento di decesso durante la degenza cardiochirurgica.                                                                                          |
| Causa_morte                                | Text              | Causa clinica del decesso (es. sepsi, shock cardiogeno, ecc.).                                                                                  |
| data_morte                                 | Date              | Data del decesso, se avvenuto.                                                                                                                  |
| esami_alla_dimissione                      | Text              | Risultati di laboratorio e strumentali prima della dimissione.                                                                                  |
| terapia_alla_dimissione                    | Text              | Terapia farmacologica prescritta alla dimissione.                                                                                               |

---

### **Istruzioni IMPORTANTI:**

- Ragiona considerando **frase per frase**.
- Non estrarre **nessuna entit√†** diversa da quelle elencate.
- Se un'entit√† non √® presente nella lettera, **non inventarla** e **non includerla** nel risultato.
- Attenzione per√≤ i nomi delle entit√† che vedi sopra sono in alcuni casi degli acronimi o diminutivi delle entit√†.
- Cerca tutte le entit√† indicate
- Il formato di output deve essere una lista JSON, dove ogni elemento √® un oggetto con **due chiavi**:
    - `"entit√†"`: il nome dell'entit√†
    - `"valore"`: il valore estratto dell'entit√†
**NON** aggiungere commenti, spiegazioni, note, intestazioni o altro: **solo** la lista JSON.
-Se trovi **tabelle**, **elenchi** o **parametri** , estrai **ogni** coppia chiave-valore aggiuntiva (senza unit√† di misura).
-Se trovi **esami** o **strumentali** (ad esempio esami di laboratorio) , estrai **ogni** coppia chiave-valore aggiuntiva (senza unit√† di misura). 

---

###Esempio di input(esempio parziale della lettera di dimission)
Si dimette in data 02/09/2019
il Sig. BERTOLOTTI FRANCO
Nato il 27/03/1939 telefono 3479927663
ricoverato presso questo ospedale dal 27/08/2019
Numero Cartella 2019034139

Diagnosi alla dimissione:
Intervento di plastica valvolare mitralica per via percutanea mediante posizionamento di duplice dispositivo Mitraclip.

Motivo del Ricovero:
Insufficienza mitralica in status post rivascolarizzazione miocardica chirurgica mediante triplice bypass coronarico.

Cenni Anamnestici:
Paziente nega farmacoallergie.
Familiarit√† positiva per cardiopatia ischemica (padre).
Ex fumatore, stop nel 1990 (1 pack/die).
Diabete mellito in tp ipoglicemizzante orale.
IRC (crea all'ingresso 2,64 mg/dl).


---

###Esmpio output(esempio parziale in JSON):

```json
[
  { "entit√†": "data_dimissione_cch", "valore": "02/09/2019" },
  { "entit√†": "nome", "valore": "FRANCO" },
  { "entit√†": "cognome", "valore": "BERTOLOTTI" },
  { "entit√†": "data_di_nascita", "valore": "27/03/1939" },
  { "entit√†": "numero di telefono", "valore": "3479927663" },
  { "entit√†": "data_ingresso_cch", "valore": "27/08/2019" },
  { "entit√†": "n_cartella", "valore": "2019034139" },
  { "entit√†": "Diagnosi text", "valore": "Intervento di plastica valvolare mitralica per via percutanea mediante posizionamento di duplice dispositivo Mitraclip." },
  { "entit√†": "Motivo ricovero", "valore": "Insufficienza mitralica in status post rivascolarizzazione miocardica chirurgica mediante triplice bypass coronarico." },
  { "entit√†": "fumo", "valore": true },
  { "entit√†": "diabete", "valore": true },
  { "entit√†": "insufficienza renale cronica", "valore": true },
  { "entit√†": "familiarita cardiovascolare", "valore": true },
  { "entit√†": "emocromo", "valore": "4.5" },
  { "entit√†": "creatinina", "valore": "1.2" }
]''',
        "coronarografia": '''
Sei un medico specializzato in cardiologia interventistica. Il tuo compito √® estrarre **esclusivamente** le seguenti entit√† dal referto di coronarografia:

### Entit√† da estrarre (solo queste):

| Entit√†                    | Tipo              |
|--------------------------|-------------------|
| n_cartella               | Number            |
| nome                     | Text              |
| cognome                  | Text              |
| data_di_nascita          | Date              |
| data_esame               | Date              |
| coronarografia text      | Text              |
| coro_tc_stenosi50        | Boolean           |
| coro_iva_stenosi50       | Boolean           |
| coro_cx_stenosi50        | Boolean           |
| coro_mo1_stenosi50       | Boolean           |
| coro_mo2_stenosi50       | Boolean           |
| coro_mo3_stenosi50       | Boolean           |
| coro_int_stenosi50       | Boolean           |
| coro_plcx_stenosi50      | Boolean           |
| coro_dx_stenosi50        | Boolean           |
| coro_pl_stenosi50        | Boolean           |
| coro_ivp_stenosi50       | Boolean           |

---

### Istruzioni IMPORTANTI:

- Ragiona considerando frase per frase.
- Non estrarre nessuna entit√† diversa da quelle elencate.
- Se un'entit√† non √® presente nel referto, non inventarla e non includerla nel risultato.
- Il formato di output deve essere una lista JSON, dove ogni elemento √® un oggetto con due chiavi:
    - "entit√†": il nome dell'entit√†
    - "valore": il valore estratto dell'entit√†
NON aggiungere commenti, spiegazioni, note, intestazioni o altro: solo la lista JSON.

Esempio di output:

```json
[
  { "entit√†": "n_cartella", "valore": "2025003002" },
  { "entit√†": "nome", "valore": "MASSIMO" },
  { "entit√†": "cognome", "valore": "RICCA" },
  { "entit√†": "data_di_nascita", "valore": "17/02/1966" },
  { "entit√†": "data_esame", "valore": "12/06/2025" },
  { "entit√†": "coronarografia text", "valore": "Paziente sottoposto a coronarografia..." },
  { "entit√†": "coro_tc_stenosi50", "valore": true },
  { "entit√†": "coro_iva_stenosi50", "valore": false }
  ...
]
''',
        "eco_preoperatorio": '''
Sei un medico specializzato in cardiochirurgia.
Estrai le seguenti entit√† dall‚Äôecocardiogramma preoperatorio:

- n_cartella (Number), nome (Text), cognome (Text), data_di_nascita (Date)
- altezza (Number), peso (Number), bmi (Number), bsa (Number)
- data_esame (Date)
- eco_text (Text)              # riassunto/valutazione
- parametri (Text)             # se trovi tabelle/elenco parametri non standard

Istruzioni:
- Se trovi tabelle/elenco parametri (es. "FE: 45 %", "TAPSE: 17 mm"), estrai ciascuna coppia nel campo **parametri** come testo strutturato "chiave: valore" separati da punto e virgola.
- Output = lista JSON di {"entit√†": <nome>, "valore": <valore>}. Nessun altro testo.
''',
        "eco_postoperatorio": '''
Sei un medico specializzato in cardiochirurgia. Estrai ESCLUSIVAMENTE:

- data_esame (Date)
- eco_text (Text)
- parametri (Text)  # opzionale: se presenti tabelle/elenco parametri

Output: lista JSON di {"entit√†": <nome>, "valore": <valore>}. Non inventare.
''',
        "tc_cuore": '''
Sei un medico specializzato in cardiochirurgia. Il tuo compito √® estrarre **esclusivamente** le seguenti entit√† dal referto di TC Cuore:

### Entit√† da estrarre (solo queste):

| Entit√†                | Tipo    | Descrizione                                      |
|----------------------|---------|--------------------------------------------------|
| n_cartella           | Number  | Numero identificativo univoco della cartella     |
| nome                 | Text    | Nome del paziente                                |
| cognome              | Text    | Cognome del paziente                             |
| data_di_nascita      | Date    | Data di nascita del paziente                     |
| data_esame           | Date    | Data di esecuzione della TC Cuore                |
| tac text             | Text    | Descrizione completa del referto TC              |
| tc_tc_stenosi50      | Boolean | Stenosi > 50% su tronco comune                   |
| tc_iva_stenosi50     | Boolean | Stenosi > 50% su IVA                             |
| tc_cx_stenosi50      | Boolean | Stenosi > 50% su CX                              |
| tc_mo1_stenosi50     | Boolean | Stenosi > 50% su MO1                             |
| tc_mo2_stenosi50     | Boolean | Stenosi > 50% su MO2                             |
| tc_mo3_stenosi50     | Boolean | Stenosi > 50% su MO3                             |
| tc_int_stenosi50     | Boolean | Stenosi > 50% su interventricolare posteriore    |
| tc_plcx_stenosi50    | Boolean | Stenosi > 50% su PL-CX                           |
| tc_dx_stenosi50      | Boolean | Stenosi > 50% su coronaria destra                |
| tc_pl_stenosi50      | Boolean | Stenosi > 50% su PL                              |
| tc_ivp_stenosi50     | Boolean | Stenosi > 50% su IVP                             |
| dimaorta_anulus      | Number  | Diametro anulus aortico                           |
| dimaorta_perimetro   | Number  | Perimetro aortico                                 |
| dimaorta_radice      | Number  | Diametro radice aortica                           |
| dimaorta_giunzione   | Number  | Diametro giunzione sinotubulare                   |
| dimaorta_asc         | Number  | Diametro aorta ascendente                         |
| dimaorta_arco        | Number  | Diametro arco aortico                             |
| dimaorta_disc        | Number  | Diametro aorta discendente                        |
| area_valv_aortica    | Number  | Area valvolare aortica                            |
| asse_lungo           | Number  | Asse lungo seno coronarico                        |
| asse_corto           | Number  | Asse corto seno coronarico                        |
| h_media_senocor      | Number  | Altezza media seno coronarico                     |

---

### Istruzioni IMPORTANTI:

- Ragiona considerando frase per frase.
- Non estrarre nessuna entit√† diversa da quelle elencate.
- Se un'entit√† non √® presente, non inventarla.
- Il formato di output deve essere una lista JSON con:
    - "entit√†": nome dell'entit√†
    - "valore": valore estratto
Nessun commento o testo aggiuntivo.
''',
        "intervento": '''
Sei un cardiochirurgo. Estrai le seguenti entit√† dal referto di intervento/verbale operatorio.

Campi anagrafici/cronologia:
- n_cartella (Number), nome (Text), cognome (Text), data_di_nascita (Date)  [mappa anche ‚ÄúDOB‚Äù, ‚Äúdob‚Äù]
- data_intervento (Date), Percorso (Text: es. "Chirurgico", "Transcatetere")

Setting operatorio:
- redo (Boolean), cec (Boolean), cannulazionearteriosa (Text), statopaz (Text),
  cardioplegia (Text), approcciochirurgico (Text)

Tempi sala (Time):
- entratainsala, iniziointervento, iniziocec, inizioclamp, inizioacc,
  fineacc, fineclamp, finecec, fineintervento, uscitasala

Equipe:
- "primo operatore cognome" (Text), "primo operatore nome" (Text)

Struttura interventi:
- num_interventi (Number)
- "intervento 1" (Text), "protesi 1" (Text), "modello 1" (Text), "numero 1" (Number), "eziologia_valvolare 1" (Text)

Testo libero:
- "intervento text" (Text)  [riassunto completo, se presente]

REGOLE:
- Output = LISTA JSON di oggetti { "entit√†": <nome>, "valore": <valore> } ‚Äî niente altro.
- Non inventare. Se un campo non √® presente, omettilo.
- Accetta sinonimi comuni (DOB‚Üídata_di_nascita; ‚Äúcentrale/periferica‚Äù per cannulazionearteriosa).
- Se sono presenti pi√π interventi ma non strutturati, popola almeno i campi ‚Äúintervento 1 / protesi 1 / ‚Ä¶‚Äù.
''',
    "anamnesi": '''
    Sei un medico. Estrai ESCLUSIVAMENTE le seguenti entit√† dall'ANAMNESI:

    - n_cartella (Number), nome (Text), cognome (Text), data_di_nascita (Date)
    - Terapia (Text)                 # terapia in atto all'ingresso
    - Allergie (Text)                # farmacoallergie/intolleranze
    - Abitudini (Text)               # fumo/alcol/altro, se presenti
    - Comorbidita (Text)             # elenco o riassunto
    - esami_all_ingresso (Text)      # labs/strumentali al ricovero
    - parametri (Text)               # se presenti tabelle/elenco parametri: riportali come "chiave: valore" separati da "; "

    REGOLE:
    - Output = LISTA JSON di oggetti: { "entit√†": "<nome>", "valore": "<valore>" } ‚Äî niente altro.
    - NON inventare. Se un campo non √® presente, omettilo.
    - Se trovi tabelle/elenco (es. "Creatinina: 1.2 mg/dL", "FE: 45 %"), concatenali in **parametri** senza unit√†, in forma "Creatinina: 1.2; FE: 45".
''',
    "epicrisi_ti": '''
    Sei un medico. Estrai ESCLUSIVAMENTE le seguenti entit√† dall‚ÄôEPICRISI di Terapia Intensiva:

    - n_cartella (Number), nome (Text), cognome (Text)
    - data_intervento (Date)
    - Decorso_post_operatorio (Text)        # ventilazione, emodinamica, complicanze, drenaggi, diuresi, etc.
    - IABP_ECMO_IMPELLA (Boolean), Inotropi (Boolean)
    - eventi_avversi_TI (Text)
    - data_dimissione_cch (Date)
    - parametri (Text)  # se presenti tabelle/elenco parametri, riportali come "chiave: valore" separati da "; "

    REGOLE:
    - Output = LISTA JSON di oggetti { "entit√†": "<nome>", "valore": "<valore>" } ‚Äî niente altro.
    - NON inventare: ometti i campi assenti.
    - Se trovi misure/tabellari, normalizzale senza unit√† in **parametri**.
''',
    "cartellino_anestesiologico": '''
    Sei un anestesista. Estrai ESCLUSIVAMENTE le seguenti entit√† dalla scheda anestesiologica intraoperatoria:

    Anagrafica/cronologia:
    - n_cartella (Number), nome (Text), cognome (Text), data_di_nascita (Date)
    - data_intervento (Date)

    Tempi sala (Time):
    - entratainsala, iniziointervento, iniziocec, inizioclamp, inizioacc,
    fineacc, fineclamp, finecec, fineintervento, uscitasala

    Tecnica/setting:
    - cec (Boolean), cardioplegia (Text), approcciochirurgico (Text)

    Dettagli anestesia:
    - anestesia (Text), farmaci_intraop (Text), eventi_intraop (Text)

    Tabelle/parametri:
    - parametri (Text) ‚Äî se presenti tabelle/elenco, riportali come "chiave: valore" separati da "; " (senza unit√†).

    REGOLE:
    - Output = LISTA JSON di oggetti { "entit√†": "<nome>", "valore": "<valore>" } ‚Äî niente altro.
    - NON inventare: ometti i campi non presenti.
    - Accetta sinonimi per i tempi (es. ‚Äúincisione‚Äù‚âàiniziointervento) mappandoli al campo corretto.
'''
    }

    def get_schema_for(self, document_type: str) -> dict:
        """
        Restituisce lo schema JSON per il tipo di documento.
        """
        if document_type not in self.SCHEMAS:
            raise ValueError(f"Schema non definito per {document_type}")
        return self.SCHEMAS[document_type]

    def get_prompt_for(self, document_type: str) -> str:
        """
        Restituisce il prompt testuale per il tipo di documento.
        """
        if document_type not in self.PROMPTS:
            raise ValueError(f"Prompt non definito per {document_type}")
        return self.PROMPTS[document_type]

    def get_spec_for(self, document_type: str) -> Dict[str, List[str]]:
        """
        Restituisce un dict con:
          - 'entities': lista di chiavi dal JSON schema
        """
        schema = self.get_schema_for(document_type)
        entities = list(schema.get("properties", {}).keys())
        return { "entities": entities }
